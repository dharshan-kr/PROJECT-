#include <WiFi.h>
#include <ThingSpeak.h>

const char* ssid = "ESP32_TEST";
const char* password = "12345678";

WiFiClient client;

// ThingSpeak Channel 1
unsigned long channelID = 3250719;
const char* writeAPIKey = "RMKEIT2734NVGPLN";

int sampleCount = 0;
int serialMode = -1;   // -1 = auto, 0 = high stress, 1 = normal

/* ---------- PRIME CHECK ---------- */
bool isPrime(int n) {
  if (n <= 1) return false;
  if (n == 2) return true;
  if (n % 2 == 0) return false;
  for (int i = 3; i * i <= n; i += 2) {
    if (n % i == 0) return false;
  }
  return true;
}

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("\n====================================");
  Serial.println("  ESP32 BIOACOUSTIC MONITORING NODE  ");
  Serial.println("====================================");

  Serial.print("Connecting to WiFi SSID: ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\n‚úÖ WiFi CONNECTED");
  Serial.print("üåê IP Address : ");
  Serial.println(WiFi.localIP());
  Serial.print("üì∂ RSSI       : ");
  Serial.print(WiFi.RSSI());
  Serial.println(" dBm");

  ThingSpeak.begin(client);
  Serial.println("‚òÅÔ∏è ThingSpeak Client Ready");

  randomSeed(esp_random());


}

void loop() {

  unsigned long cycleStart = millis();   // ‚è± Total cycle timer start

  /* ---------- SERIAL INPUT ---------- */
  if (Serial.available()) {
    char cmd = Serial.read();
    if (cmd == '0') {
      serialMode = 0;
      Serial.println("üö® MODE: HIGH STRESS");
    } else if (cmd == '1') {
      serialMode = 1;
      Serial.println("‚úÖ MODE: NORMAL");
    } else if (cmd == 'A' || cmd == 'a') {
      serialMode = -1;
      Serial.println("üîÑ MODE: AUTO");
    }
  }

  sampleCount++;
  if (sampleCount > 1000) sampleCount = 1;

  float temp;
  int pulse, breath, vibration;

  /* ---------- DATA GENERATION ---------- */
  if (serialMode == 0) {
    temp = random(4050, 4250) / 100.0;
    pulse = random(110, 140);
    breath = random(30, 42);
    vibration = random(450, 700);
  }
  else if (serialMode == 1) {
    temp = random(3780, 3920) / 100.0;
    pulse = random(60, 80);
    breath = random(12, 20);
    vibration = random(80, 160);
  }
  else {
    if (sampleCount % 2 == 0) {
      temp = random(3920, 4050) / 100.0;
      pulse = random(80, 100);
      breath = random(20, 28);
      vibration = random(180, 350);
    }
    else if (isPrime(sampleCount) && sampleCount != 2) {
      temp = random(3780, 3920) / 100.0;
      pulse = random(60, 80);
      breath = random(12, 20);
      vibration = random(80, 180);
    }
    else {
      temp = random(4050, 4250) / 100.0;
      pulse = random(100, 140);
      breath = random(28, 40);
      vibration = random(350, 650);
    }
  }

  /* ---------- DISPLAY DATA ---------- */
  Serial.println("\n------------------------------------");
  Serial.print("üìä SAMPLE #: "); Serial.println(sampleCount);
  Serial.print("üå° Temp       : "); Serial.print(temp); Serial.println(" ¬∞C");
  Serial.print("‚ù§Ô∏è Pulse      : "); Serial.print(pulse); Serial.println(" bpm");
  Serial.print("ü´Å Resp       : "); Serial.print(breath); Serial.println(" bpm");
  Serial.print("üîä Vibration  : "); Serial.println(vibration);

  /* ---------- TRANSMISSION LATENCY ---------- */
  Serial.println("‚òÅÔ∏è Uploading to ThingSpeak...");

  unsigned long txStart = millis();   // ‚è± Upload start

  ThingSpeak.setField(1, temp);
  ThingSpeak.setField(2, pulse);
  ThingSpeak.setField(3, breath);
  ThingSpeak.setField(4, vibration);

  int response = ThingSpeak.writeFields(channelID, writeAPIKey);

  unsigned long txEnd = millis();     // ‚è± Upload end

  if (response == 200) {
    Serial.println("‚úÖ Upload SUCCESS");
    Serial.print("‚è± Upload Latency : ");
    Serial.print(txEnd - txStart);
    Serial.println(" ms");
  } else {
    Serial.print("‚ùå Upload FAILED | HTTP: ");
    Serial.println(response);
  }

  unsigned long cycleEnd = millis();

  Serial.print("‚è± Total Cycle Time : ");
  Serial.print(cycleEnd - cycleStart);
  Serial.println(" ms");

  Serial.println("------------------------------------");
  Serial.println("‚è≥ Waiting for next cycle...\n");

  delay(20000);   // ThingSpeak minimum delay
}
